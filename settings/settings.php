<?php
# 
# This file is part of Roundcube "settings" plugin.
# 
# Your are not allowed to distribute this file or parts of it.
# 
# This file is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
# 
# Copyright (c) 2012 - 2013 Roland 'Rosali' Liebl - all rights reserved.
# dev-team [at] myroundcube [dot] com
# http://myroundcube.com
# 
class settings extends rcube_plugin{var$task='settings';var$noajax=true;private$sections=array('general','mailbox','compose','mailview','addressbook','folders','server');static private$plugin='settings';static private$author='myroundcube@mail4us.net';static private$authors_comments='';static private$download='http://myroundcube.googlecode.com';static private$version='4.2';static private$date='01-04-2013';static private$licence='All Rights reserved';static private$requirements=array('Roundcube'=>'0.8','PHP'=>'5.2.1');static private$prefs=null;static private$config_dist='config.inc.php.dist';function init(){$this->task='settings';$this->_load_config();$B=rcmail::get_instance();$this->register_handler('plugin.account_sections',array($this,'account_sections'));$this->add_hook('preferences_sections_list',array($this,'account_link'));$this->add_hook('preferences_save',array($this,'preferences_save'));$this->add_hook('preferences_list',array($this,'prefs_table'));$G=$B->config->get('skin');$V=get_input_value('_skin',RCUBE_INPUT_POST);if($V!="")$G=$V;if(!file_exists('plugins/settings/skins/'.$G.'/settings.css')){if(!file_exists('plugins/settings/skins/classic/settings.css'))return;else$G="classic";}$this->include_stylesheet('skins/'.$G.'/settings.css');$R=new rcube_browser();if($R->ie){if($R->ver<8)$this->include_stylesheet('skins/'.$G.'/iehacks.css');if($R->ver<7)$this->include_stylesheet('skins/'.$G.'/ie6hacks.css');}$this->add_hook('template_object_userprefs',array($this,'userprefs'));$this->add_texts('localization/');$B->output->add_label('settings.account');}static function about($P=false){$K=self::$requirements;foreach(array('required_','recommended_')as$O){if(is_array($K[$O.'plugins'])){foreach($K[$O.'plugins']as$J=>$X){if(class_exists($J)&&method_exists($J,'about')){$a=new$J(false);$K[$O.'plugins'][$J]=array('method'=>$X,'plugin'=>$a->about($P),);}else{$K[$O.'plugins'][$J]=array('method'=>$X,'plugin'=>$J,);}}}}$Y=array();if(is_string(self::$config_dist)){if(is_file($d=INSTALL_PATH.'plugins/'.self::$plugin.'/'.self::$config_dist))include$d;else write_log('errors',self::$plugin.': '.self::$config_dist.' is missing!');}$N=array('plugin'=>self::$plugin,'version'=>self::$version,'date'=>self::$date,'author'=>self::$author,'comments'=>self::$authors_comments,'licence'=>self::$licence,'download'=>self::$download,'requirements'=>$K,);if(is_array(self::$prefs))$N['config']=array_merge($Y,array_flip(self::$prefs));else$N['config']=$Y;if(is_array($P)){$W=array('plugin'=>self::$plugin);foreach($P as$E){$W[$E]=$N[$E];}return$W;}else{return$N;}}function _load_config(){$B=rcmail::get_instance();if(!in_array('global_config',$B->config->get('plugins'))){$this->load_config();$this->require_plugin('qtip');}}function account_link($A){$B=rcmail::get_instance();$G=$B->config->get('skin');$C=array();foreach($this->sections as$E=>$Q){$C[$Q]=$A['list'][$Q];unset($A['list'][$Q]);}$A['list']['general']=$C['general'];$A['list']['mailbox']=$C['mailbox'];$A['list']['compose']=$C['compose'];$A['list']['mailview']=$C['mailview'];$A['list']['mh_preferences']=array();$A['list']['identitieslink']=array();$A['list']['addressbook']=$C['addressbook'];$A['list']['addressbookcarddavs']=array();$A['list']['addressbooksharing']=array();$A['list']['folderslink']=array();$A['list']['folders']=$C['folders'];if($G=='classic'){$A['list']['folders']['section']=$A['list']['folders']['section'];}$A['list']['calendarlink']=array();$A['list']['calendarcategories']=array();$A['list']['calendarfeeds']=array();$A['list']['calendarsharing']=array();$A['list']['nabblelink']=array();$A['list']['plugin_manager']=array();$A['list']['plugin_manager_update']=array();$A['list']['plugin_manager_customer']=array();$A['list']['accountslink']=array();$A['list']['server']=$C['server'];$I=$GLOBALS['settingsnav'];if(is_array($B->config->get('settingsnav')))$I=array_merge($I,$B->config->get('settingsnav'));if(count($I)>0){$A['list']['accountlink']['id']='accountlink';$A['list']['accountlink']['section']=$this->gettext('account');}if(strtolower($B->user->data['username'])!=strtolower($_SESSION['username'])){unset($A['list']['accountlink']);}return$A;}function account_sections(){$B=rcmail::get_instance();if(isset($_GET['_msg'])){$B->output->command('display_message',urldecode($_GET['_msg']),$_GET['_type']);}$I=(array)$GLOBALS['settingsnav'];if(is_array($B->config->get('settingsnav')))$I=array_merge($I,$B->config->get('settingsnav'));$F="<div id=\"userprefs-accountblocks\">\n";foreach($I as$E=>$H){if(!class_exists($E))continue;if(!empty($H['descr'])){$D++;$F.="<div class=\"userprefs-accountblock\" id='accountsblock_$D'>\n";$F.="<div class=\"userprefs-accountblock-border\">\n";$F.="&raquo;&nbsp;<a class=\"plugin-description-link\" href=\"".$H['href']."\" onclick='".$H['onclick']."'>".$this->gettext($H['descr'].'.'.$H['label'])."</a>\n";$F.="</div>\n";$F.="</div>\n";$F.='
<script>
var element = $("#accountsblock_'.$D.'");
element.qtip({
  content: {title:\''.$this->gettext($H['descr'].'.'.$H['label']).'\', text: \''.$this->gettext($H['descr'].'.description').'\'},
  position: {
    my: "top left",
    at: "left bottom",
    target: element,
    viewport: $(window)
  },
  hide: {
    effect: function () { $(this).slideUp(5, function(){ $(this).dequeue(); }); }
  },
  style: {
    classes: "ui-tooltip-light"
  }
});
</script>
';}}$F.="</div>\n<style>fieldset{border: none;}</style>\n";return$F;}function prefs_table($A){if($A['section']=='accountlink'){$A['blocks']['main']['options']['accountlink']['title']="";$A['blocks']['main']['options']['accountlink']['content']=$this->account_sections("");$this->include_script('settings.js');}return$A;}function userprefs($L){$B=rcmail::get_instance();(array)$C=explode("<fieldset>",$L['content']);for($D=1;$D<count($C);$D++){$c=$B->list_languages();$T=array_flip($B->config->get('limit_languages',array()));if(count($T)>0){foreach($c as$E=>$M){if(!isset($T[$E])){$C[$D]=str_replace("<option value=\"$E\">$M</option>\n","",$C[$D]);}}}$b=rcmail_get_skins();$e=strtolower($B->config->get('skin','classic'));$U=array_flip($B->config->get('limit_skins',array()));if(count($U)>0){foreach($b as$E=>$M){if(!isset($U[$M])){$B->output->add_script('$("#rcmfd_skin'.$M.'").parent().parent().parent().hide();','docready');}}}$C[$D]="<div class=\"settingsplugin\"><fieldset>".str_replace("</fieldset>","</fieldset></div>",$C[$D]);if($_GET['_section']=="folders"||$_POST['_section']=="folders"){$Z=$_SESSION['username'];$C[$D]=str_replace("</legend>"," ::: ".$Z."</legend>",$C[$D]);$C[$D]=str_replace("remotefolders :::",$this->gettext('remotefolders')." :::",$C[$D]);}}$L['content']=implode('',$C);if($_GET['_section']=="general"||$_POST['_section']=="general"){$L['content'].=html::tag('br').html::tag('fieldset',null,html::tag('legend',null,$this->gettext('skin_preview')).html::tag('div',array('id'=>'skin_preview','align'=>'center'),html::tag('img',array('id'=>'skin_preview_img','src'=>'./plugins/settings/skins/'.$B->config->get('skin','classic').'/images/'.$B->config->get('skin','classic').'.png')))).html::tag('script',array('type'=>'text/javascript'),'$(document).ready(function(){$(".skinitem").click(function(){ $("#skin_preview_img").attr("src", "./plugins/settings/skins/" + $(this).children().val() + "/images/" + $(this).children().val() + ".png"); }); });');}return$L;}function preferences_save($S){$B=rcmail::get_instance();if($S['section']=='general'){if($S['prefs']['skin']!=$B->config->get('skin','classic'))$B->output->add_script("parent.location.href = './?_task=settings';");}return$S;}}