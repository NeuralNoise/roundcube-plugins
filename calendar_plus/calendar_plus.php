<?php
# 
# This file is part of Roundcube "calendar_plus" plugin.
# 
# Your are not allowed to distribute this file or parts of it.
# 
# This file is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
# 
# Copyright (c) 2012 - 2013 Roland 'Rosali' Liebl - all rights reserved.
# dev-team [at] myroundcube [dot] com
# http://myroundcube.com
# 
class calendar_plus extends rcube_plugin{static private$plugin='calendar_plus';static private$author='myroundcube@mail4us.net';static private$authors_comments=null;static private$download='http://myroundcube.googlecode.com';static private$version='1.0.15';static private$date='01-03-2013';static private$licence='All Rights reserved';static private$requirements=array('Roundcube'=>'0.7.1','PHP'=>'5.2.1');static private$f;static private$calskin='classic';private$ical_parts=array();var$utils;function init(){self::$f=$this;$A=rcmail::get_instance();$tB=$A->config->get('skin','classic');if(!is_dir(INSTALL_PATH.'plugins/calendar/'.$tB)){self::$calskin='classic';}self::$calskin=$tB;require_once(INSTALL_PATH.'plugins/calendar/program/utils.php');$this->utils=new Utils($A);$this->add_hook('startup',array($this,'startup'));$this->add_hook('request_token',array($this,'switchUserToken'));$this->add_hook('template_object_ics_upload',array($this,'upload_field'));if($A->action=='show'||$A->action=='preview'){$this->add_hook('message_load',array($this,'message_load'));$this->add_hook('message_part_structure',array($this,'message_part_structure'));$this->add_hook('template_object_messagebody',array($this,'html_import'));$this->add_hook('render_page',array($this,'preview_events'));}}static function about($dB=false){$FB=self::$requirements;foreach(array('required_','recommended_')as$k){if(is_array($FB[$k.'plugins'])){foreach($FB[$k.'plugins']as$t=>$m){if(class_exists($t)&&method_exists($t,'about')){$PC=new$t(false);$FB[$k.'plugins'][$t]=array('method'=>$m,'plugin'=>$PC->about($dB),);}else{$FB[$k.'plugins'][$t]=array('method'=>$m,'plugin'=>$t,);}}}}$F=array('plugin'=>self::$plugin,'version'=>self::$version,'date'=>self::$date,'author'=>self::$author,'comments'=>self::$authors_comments,'licence'=>self::$licence,'download'=>self::$download,'requirements'=>$FB,);if(is_array($dB)){$s=array('plugin'=>self::$plugin);foreach($dB as$B){$s[$B]=$F[$B];}return$s;}else{return$F;}}function startup(){$A=rcmail::get_instance();if($A->action=='plugin.calendar_get_shares'){$_B=get_input_value('access',RCUBE_INPUT_GET);$hB='';if($_B==2){$hB='readonly_';}$UC=get_input_value('rcuser',RCUBE_INPUT_GET);$EB='SELECT * from '.get_table_name('users').' WHERE username=? AND mail_host=?';$SC=$A->db->query($EB,$UC,$A->config->get('default_host'));$p=$A->db->fetch_assoc($SC);$uB=$p;$p=unserialize($p['preferences']);$F=array();if(is_array($p)){foreach($p as$B=>$E){if($_B==1){$B=str_replace('_readonly_','_',$B);}if(substr($B,0,strlen('cal_shares_'.$hB))=='cal_shares_'.$hB){if($E){$F[$B]=$E;}}}}$m=get_input_value('method',RCUBE_INPUT_GET);if(count($F)>0&&$p['caldav_notify']){if($m=='PUT'||$m=='DELETE'||$m=='MOVE'){$JC=get_input_value('rcuser',RCUBE_INPUT_GET);$bB=base64_decode(get_input_value('request',RCUBE_INPUT_GET));$AB=explode('/',$bB);$Z=$AB[count($AB)-2];$AB=$AB[count($AB)-1];$XC='principals/'.$JC;$dC=$A->config->get('db_sabredav_dsn');$w=new rcube_mdb2($dC,'',FALSE);$w->set_debug((bool)$A->config->get('sql_debug'));$w->db_connect('r');$EB='SELECT id FROM calendars WHERE principaluri=? AND uri=?';$s=$w->query($EB,$XC,$Z);$aB=$w->fetch_assoc($s);$aB=$aB['id'];$EB='SELECT calendardata FROM calendarobjects WHERE uri=? AND calendarid=?';$s=$w->query($EB,$AB,$aB);$KB=$w->fetch_assoc($s);$KB=$KB['calendardata'];if($KB){include(INSTALL_PATH.'plugins/calendar/localization/en_US.inc');$MC=$Q;if(file_exists(INSTALL_PATH.'plugins/calendar/localization/'.$uB['language'].'.inc')){include(INSTALL_PATH.'plugins/calendar/localization/'.$uB['language'].'.inc');$Q=array_merge($MC,$Q);}$r=$p['caldav_notify_to'];$o=$Q['calendar_modified']." (".ucwords($Z).")";switch($m){case'PUT':$q=sprintf($Q['notify_header'],$r)."<br /><br />".sprintf($Q['event_modified'],ucwords($Z))."<br /><br /><a href='$bB' target='_new'>$bB</a><br /><br />".$Q['regards']."<br />".$A->config->get('notify_sign',$Q['administrator'])."<br /><hr />".$Q['notify_footer']."<hr />".$Q['notify_details'];break;case'DELETE':$q=sprintf($Q['notify_header'],$r)."<br /><br />".sprintf($Q['event_deleted'],ucwords($Z))."<br /><br />".$Q['regards']."<br />".$A->config->get('notify_sign',$Q['administrator'])."<br /><hr />".$Q['notify_footer']."<hr />".$Q['notify_details'];break;default:$q=false;}if($q){$this->notify($A->config->get('cron_sender','noreply'),$r,$o,$q,$KB);}}}}echo serialize($F);if(!$_SESSION['user_id']){$A->session->destroy(session_id());}exit;}}private function notify($MB,$r,$o,$q,$z){$A=rcmail::get_instance();if(function_exists('mb_encode_mimeheader')){mb_internal_encoding(RCMAIL_CHARSET);$o=mb_encode_mimeheader($o,RCMAIL_CHARSET,'Q',$A->config->header_delimiter(),8);}else{$o='=?UTF-8?B?'.base64_encode($o).'?=';}$XB=md5(rand().microtime());$b="Return-Path: $MB\r\n";$b.="MIME-Version: 1.0\r\n";$b.="X-RC-Attachment: ICS\r\n";$b.="Content-Type: multipart/mixed; boundary=\"=_$XB\"\r\n";$b.="Date: ".date('r',time())."\r\n";$b.="From: $MB\r\n";$b.="To: $r\r\n";$b.="Subject: $o\r\n";$b.="Reply-To: $MB\r\n";$W="--=_$XB";$W.="\r\n";$WB=md5(rand().microtime());$W.="Content-Type: multipart/alternative; boundary=\"=_$WB\"\r\n\r\n";$l="--=_$WB";$l.="\r\n";$l.="Content-Transfer-Encoding: 7bit\r\n";$l.="Content-Type: text/plain; charset=".RCMAIL_CHARSET."\r\n";$qB=$A->config->get('line_length',72);$RC=new html2text($q,false,true,0);$iB=rc_wordwrap($RC->get_text(),$qB,"\r\n");$iB=wordwrap($iB,998,"\r\n",true);$l.="$iB\r\n";$l.="--=_$WB";$l.="\r\n";$W.=$l;$W.="Content-Transfer-Encoding: quoted-printable\r\n";$W.="Content-Type: text/html; charset=".RCMAIL_CHARSET."\r\n\r\n";$W.=str_replace("=","=3D",$q);$W.="\r\n\r\n";$W.="--=_$WB--";$W.="\r\n\r\n";$BB="--=_$XB";$BB.="\r\n";$BB.="Content-Type: text/calendar; name=calendar.ics; charset=".RCMAIL_CHARSET."\r\n";$BB.="Content-Transfer-Encoding: base64\r\n\r\n";$BB.=chunk_split(base64_encode($z),$qB,"\r\n");$BB.="--=_$XB--";$W.=$BB;if(!is_object($A->smtp))$A->smtp_init(true);$A->smtp->send_mail($MB,$r,$b,$W);}static function load_settings($N=false,$H){$A=rcmail::get_instance();if($N=='feeds'){$A->output->add_label('calendar.remove_feed');$sB=(array)$A->config->get('public_categories',array());$h=array_merge((array)$A->config->get('categories',array()),$sB);$h=array_merge(array(self::$f->gettext('calendar.defaultcategory')=>$A->config->get('default_category')),$h);$TC="var categories = ".json_encode($h).';';$A->output->add_script($TC);self::$f->include_script('../calendar/program/js/settings.js');$H['blocks']['calendarfeeds']['name']=self::$f->gettext('calendar.feeds');$D='rcmfd_calendarfeeds';$oB=(array)$A->config->get('calendarfeeds',array());$I='';if(count($oB)<=$A->config->get('max_feeds',3))$I='<input type="button" value="+" title="'.self::$f->gettext('calendar.add_feed').'" onClick="addRowCalFeeds(60)">';$H['blocks']['calendarfeeds']['options']['calendarfeeds']=array('title'=>html::label($D,self::$f->gettext('calendar.calendar_feeds')),'content'=>$I,);foreach($oB as$B=>$E){$D='rcmfd_calendarfeed_'.$B.'_'.$E;$QC=new html_inputfield(array('name'=>'_calendarfeeds[]','onclick'=>'this.select()','id'=>$D,'size'=>60,'title'=>$B));$xB=new html_select(array('name'=>'_feedscategories[]','id'=>$D));$RB=array_merge((array)$A->config->get('categories',array()),$sB);$RB=array_merge(array(self::$f->gettext('calendar.defaultcategory')=>$A->config->get('default_category')),$RB);$xB->add(array_flip($RB),$RB);$H['blocks']['calendarfeeds']['options']['calendarfeed_'.$B]=array('title'=>html::label($D,''),'content'=>'<input type="button" value="X" onclick="removeRow(this.parentNode.parentNode)" title="'.self::$f->gettext('calendar.remove_feed').'" />&nbsp;'.$QC->show($B)."&nbsp;".$xB->show($E),);}}else if($N=='sharing'){if(class_exists('sabredav')&&$A->config->get('backend')=='caldav'){$lB=sabredav::about(array('version'));$lB=$lB['version'];if($lB>='4'){$O=self::$f->local_skin_path();if($O=='skins/larry')$O='skins/classic';$SB='';$UB='./'.$O.'/images/icons/delete.png';if($A->config->get('skin')=='larry'){$SB='background: url(./skins/larry/images/buttons.png) -7px -377px no-repeat;';$UB='plugins/carddav/skins/larry/blank.gif';}$D='rcmfd_cal_token';$P=$A->config->get('caltoken');$Y='document.getElementById("'.$D.'").value="";';$g=html::tag('input',array('type'=>'image','style'=>$SB,'name'=>'_caltoken_submit','value'=>'0','src'=>$UB,'onclick'=>$Y,'align'=>'absmiddle','alt'=>self::$f->gettext('delete'),'title'=>self::$f->gettext('delete')));$a='readonly';$c=self::$f->gettext('calendar.isenabled');if(!$P){$Y='document.getElementById("'.$D.'").disabled="";document.forms.form.submit();';$g="&nbsp;".html::tag('input',array('name'=>'_caltoken_submit','value'=>'1','type'=>'checkbox','onclick'=>$Y));$c=self::$f->gettext('calendar.isdisabled');}if(isset($_GET['_framed'])){$H['blocks']['calendar_shares']['name']=self::$f->gettext('calendar.confidentialcaldavaccess');$J=new html_inputfield(array('readonly'=>'readonly','value'=>$_SESSION['username'],'size'=>strlen($_SESSION['username'])));$H['blocks']['calendar_shares']['options']['username']=array('title'=>html::label($D,Q(self::$f->gettext('username'))),'content'=>$J->show());$H['blocks']['calendar_shares']['name']=sprintf(self::$f->gettext('calendar.confidentialcaldavaccess'),self::$f->gettext('calendar.readwrite').'&nbsp;'.$c);$J=new html_inputfield(array('name'=>'_caltoken',$a=>$a,'id'=>$D,'value'=>$P,'size'=>8,'maxlength'=>8));$H['blocks']['calendar_shares']['options']['token']=array('title'=>html::label($D,Q(self::$f->gettext('calendar.caltoken'))),'content'=>$J->show($P)."&nbsp;$g",);$H['blocks']['calendar_shares']['options']['shares']=array('title'=>'&nbsp;'.html::tag('b',null,html::label($D,Q(self::$f->gettext('calendar.share')))),'content'=>html::tag('b',null,Q(self::$f->gettext('calendar.resource'))));$C=$A->config->get('caldav_url');$C=str_replace('%u',$_SESSION['username'],$C);if(strpos($C,'?')===false){$C.='?issabredav=1';}else{$C.='&issabredav=1';}$F=calendar_plus::isSabreDAV($C);if($F){$C=str_replace('%u',$_SESSION['username'],$A->config->get('caldav_url'));if(strpos($C,'?')===false){$C.='?access=1';}else{$C.='&access=1';}$D='rcmfd_cal_shares_default';$V=$A->config->get('cal_shares_events')?true:false;$X=new html_checkbox(array('name'=>'_cal_shares_events','id'=>$D,'value'=>1,'onclick'=>'document.forms.form.submit();'));$J=new html_inputfield(array('readonly'=>'readonly','value'=>$C,'size'=>80));$H['blocks']['calendar_shares']['options']['resources_default']=array('title'=>$X->show($V).'&nbsp;'.self::$f->gettext('calendar.defaultcategory'),'content'=>$J->show());}$CB=$A->config->get('caldavs',array());foreach($CB as$R=>$Z){$C=str_replace('%u',$_SESSION['username'],$Z['url']);if(strpos($C,'?')===false){$C.='?issabredav=1';}else{$C.='&issabredav=1';}$F=calendar_plus::isSabreDAV($C);if($F){$C=str_replace('%u',$_SESSION['username'],$Z['url']);if(strpos($C,'?')===false){$C.='?access=1';}else{$C.='&access=1';}$D='rcmfd_cal_shares_'.$R;$V=$A->config->get('cal_shares_'.strtolower($R))?true:false;$X=new html_checkbox(array('name'=>'_cal_shares_'.strtolower($R),'value'=>1,'onclick'=>'document.forms.form.submit();'));$J=new html_inputfield(array('readonly'=>'readonly','value'=>$C,'size'=>80));$H['blocks']['calendar_shares']['options']['resources_'.$R]=array('title'=>$X->show($V).'&nbsp;'.$R,'content'=>$J->show());}}$H['blocks']['calendar_shares']['options']['shareshint']=array('title'=>'','content'=>html::tag('small',null,html::tag('b',null,self::$f->gettext('calendar.sharehint'))));$D='rcmfd_cal_token_davreadonly';$P=$A->config->get('caltoken_davreadonly','');$Y='document.getElementById("'.$D.'").value="";';$g=html::tag('input',array('type'=>'image','style'=>$SB,'name'=>'_caltoken_davreadonly_submit','value'=>'0','src'=>$UB,'onclick'=>$Y,'align'=>'absmiddle','alt'=>self::$f->gettext('delete'),'title'=>self::$f->gettext('delete')));$a='readonly';$c=self::$f->gettext('calendar.isenabled');if($P==""){$Y='document.getElementById("'.$D.'").disabled="";document.forms.form.submit();';$g="&nbsp;".html::tag('input',array('name'=>'_caltoken_davreadonly_submit','value'=>'1','type'=>'checkbox','onclick'=>$Y));$c=self::$f->gettext('carddav.isdisabled');}$H['blocks']['calendar_shares_readonly']['name']=self::$f->gettext('calendar.confidentialcaldavaccess_readonly');$J=new html_inputfield(array('readonly'=>'readonly','value'=>$_SESSION['username'],'size'=>strlen($_SESSION['username'])));$H['blocks']['calendar_shares_readonly']['options']['username']=array('title'=>html::label($D,Q(self::$f->gettext('username'))),'content'=>$J->show());$H['blocks']['calendar_shares_readonly']['name']=sprintf(self::$f->gettext('calendar.confidentialcaldavaccess'),self::$f->gettext('calendar.readonly').'&nbsp;'.$c);$J=new html_inputfield(array('name'=>'_caltoken_davreadonly',$a=>$a,'id'=>$D,'value'=>$P,'size'=>8,'maxlength'=>8));$H['blocks']['calendar_shares_readonly']['options']['token']=array('title'=>html::label($D,Q(self::$f->gettext('calendar.caltoken'))),'content'=>$J->show($P)."&nbsp;$g",);$H['blocks']['calendar_shares_readonly']['options']['shares_readonly']=array('title'=>'&nbsp;'.html::tag('b',null,html::label($D,Q(self::$f->gettext('calendar.share')))),'content'=>html::tag('b',null,Q(self::$f->gettext('calendar.resource'))));$C=$A->config->get('caldav_url');if(strpos($C,'?')===false){$C.='?issabredav=1';}else{$C.='&issabredav=1';}$F=calendar_plus::isSabreDAV($C);if($F){$C=str_replace('%u',$_SESSION['username'],$A->config->get('caldav_url'));if(strpos($C,'?')===false){$C.='?access=2';}else{$C.='&access=2';}$D='rcmfd_cal_shares_davreadonly_default';$V=$A->config->get('cal_shares_readonly_events')?true:false;$X=new html_checkbox(array('name'=>'_cal_shares_readonly_events','id'=>$D,'value'=>1,'onclick'=>'document.forms.form.submit();'));$J=new html_inputfield(array('readonly'=>'readonly','value'=>$C,'size'=>80));$H['blocks']['calendar_shares_readonly']['options']['resources_default']=array('title'=>$X->show($V).'&nbsp;'.self::$f->gettext('calendar.defaultcategory'),'content'=>$J->show());}$CB=$A->config->get('caldavs',array());foreach($CB as$R=>$Z){$C=str_replace('%u',$_SESSION['username'],$Z['url']);if(strpos($C,'?')===false){$C.='?issabredav=1';}else{$C.='&issabredav=1';}$F=calendar_plus::isSabreDAV($C);if($F){$C=str_replace('%u',$_SESSION['username'],$Z['url']);if(strpos($C,'?')===false){$C.='?access=2';}else{$C.='&access=2';}$D='rcmfd_cal_shares_readonly_'.$R;$V=$A->config->get('cal_shares_readonly_'.strtolower($R))?true:false;$X=new html_checkbox(array('name'=>'_cal_shares_readonly_'.strtolower($R),'value'=>1,'onclick'=>'document.forms.form.submit();'));$J=new html_inputfield(array('readonly'=>'readonly','value'=>$C,'size'=>80));$H['blocks']['calendar_shares_readonly']['options']['resources_readonly_'.$R]=array('title'=>$X->show($V).'&nbsp;'.$R,'content'=>$J->show());}}$H['blocks']['calendar_shares_readonly']['options']['shareshint']=array('title'=>'','content'=>html::tag('small',null,html::tag('b',null,self::$f->gettext('calendar.sharehint_readonly'))));$A->output->add_script('$("form").attr("action", "./?_framed=1");','docready');}}}$D='rcmfd_cal_token_readonly';$LC=md5($LC);$P=$A->config->get('caltokenreadonly','');$Y='document.getElementById("'.$D.'").value="";';$g=html::tag('input',array('type'=>'image','style'=>$SB,'name'=>'_caltokenfeeds_submit','value'=>'0','src'=>$UB,'onclick'=>$Y,'align'=>'absmiddle','alt'=>self::$f->gettext('delete'),'title'=>self::$f->gettext('delete')));$a='readonly';$c=self::$f->gettext('calendar.isenabled');$DC=true;$a='readonly';$c=self::$f->gettext('calendar.isenabled');if($P==""){$P=md5($_SESSION['username'].session_id().time());$DC=false;$a='disabled';$Y='document.getElementById("'.$D.'").disabled="";document.forms.form.submit();';$g="&nbsp;".html::tag('input',array('name'=>'_caltokenfeeds_submit','value'=>'1','type'=>'checkbox','onclick'=>$Y));$c=self::$f->gettext('calendar.isdisabled');}$H['blocks']['calendar_readonly']['name']=sprintf(self::$f->gettext('calendar.calconfidentialurl'),self::$f->gettext('calendar.readonly').'&nbsp;'.$c);$J=new html_inputfield(array('name'=>'_caltokenreadonly',$a=>$a,'id'=>$D,'value'=>$P,'size'=>32,'maxlength'=>32));$H['blocks']['calendar_readonly']['options']['token']=array('title'=>html::label($D,Q(self::$f->gettext('calendar.caltoken'))),'content'=>$J->show($P)."&nbsp;$g",);if($DC){$D='rcmfd_cal_icsurl_readonly';if($A->config->get('cal_short_urls',false)){$i=calendar::getUrl()."ics/".$A->user->data['user_id']."/".$A->config->get('caltokenreadonly');}else{$i=calendar::getURL()."?_task=dummy&_action=plugin.calendar_showlayer&_userid=".$A->user->data['user_id']."&_ct=".$A->config->get('caltokenreadonly').'&_ics=1';}$J=new html_inputfield(array('name'=>'_calicsurl','readonly'=>'readonly','onclick'=>'this.select()','id'=>$D,'value'=>$i,'size'=>80));$H['blocks']['calendar_readonly']['options']['icsurl']=array('title'=>html::label($D,Q(self::$f->gettext('calendar.calicsurl'))),'content'=>$J->show($i),);$D='rcmfd_cal_feedurl_readonly';if($A->config->get('cal_short_urls',false)){$i=calendar::getUrl()."rc/".$A->user->data['user_id']."/".$A->config->get('caltokenreadonly');}else{$i=calendar::getURL()."?_task=dummy&_action=plugin.calendar_showlayer&_userid=".$A->user->data['user_id']."&_ct=".$A->config->get('caltokenreadonly');}$J=new html_inputfield(array('name'=>'_calfeedurl','readonly'=>'readonly','onclick'=>'this.select()','id'=>$D,'value'=>$i,'size'=>80));$H['blocks']['calendar_readonly']['options']['feedurl']=array('title'=>html::label($D,Q(self::$f->gettext('calendar.calfeedurl'))),'content'=>$J->show($i),);$H['blocks']['calendar_readonly']['options']['accesshint']=array('title'=>'','content'=>html::tag('small',null,html::tag('b',null,self::$f->gettext('calendar.icsaccesshint'))));}}else if($N=='birthdays'){$D='rcmfd_show_birthdays';$V=$A->config->get('show_birthdays');$X=new html_checkbox(array('name'=>'_show_birthdays','id'=>$D,'value'=>1));$H['blocks']['calendar']['options']['show_birthdays']=array('title'=>html::label($D,Q(self::$f->gettext('calendar.showbirthdays'))),'content'=>$X->show($V?1:0),);}else if($N=='upcoming'){$D='rcmfd_upcoming_cal';$V=$A->config->get('upcoming_cal');$X=new html_checkbox(array('name'=>'_upcoming_cal','id'=>$D,'value'=>1));$H['blocks']['calendar']['options']['upcoming_cal']=array('title'=>html::label($D,Q(self::$f->gettext('calendar.show_upcoming_cal'))),'content'=>$X->show($V?1:0),);}return$H;}static function load_backend($TB='caldav'){$A=rcmail::get_instance();if($A->action=='plugin.calendar_showlayer'||get_input_value('_cron',RCUBE_INPUT_GPC)){if($A->action=='plugin.calendar_showlayer'||get_input_value('_userid',RCUBE_INPUT_GPC)){$A->set_task('dummy');$kB=get_input_value('_userid',RCUBE_INPUT_GPC);}else{$kB=$_SESSION['user_id'];}if($kB){$LB=calendar::getUser($kB);$T=unserialize($LB['preferences']);if(!isset($T['backend'])){$T['backend']=$A->config->get('backend','database');}$TB=$T['backend'];if($TB=='caldav'){$A->config->set('caldav_user',$T['caldav_user']);$A->config->set('caldav_url',$T['caldav_url']);$NC=$A->decrypt($T['caldav_password']);if($NC=='%p'){if(!empty($LB['password'])){$T['caldav_password']=$LB['password'];}else{write_log('calendar','User "'.$LB['username'].'" has saved placeholder %p as password. Shared calendaring fails. Install "savepassword" plugin.');}}$A->config->set('caldav_password',$T['caldav_password']);$A->config->set('caldavs',$T['caldavs']);$A->config->set('categories',$T['categories']);$A->config->set('googleuser',$T['googleuser']);$A->config->set('googlepass',$T['googlepass']);$A->config->set('backend',$T['backend']);}}else{$TB='database';}}return$TB;}static function load_birthdays($n=array()){$A=rcmail::get_instance();$OC=$A->config->get('autocomplete_addressbooks',array('sql'));$QB=get_input_value('_end',RCUBE_INPUT_GPC);foreach($OC as$VC){$EC=$A->get_address_book($VC);$EC->set_pagesize(9999);$WC=$EC->list_records();while($M=$WC->next()){if(!empty($M['name'])&&!empty($M['birthday'])){list($PB,$v,$IB)=explode('-',(string)$M['birthday'][0]);if(!$QB){if($v<date('m')){$d=gmmktime(0,0,0,$v,$IB,date('Y')+1);}else{$d=gmmktime(0,0,0,$v,$IB);}$n['all'][]=array('timestamp'=>$d,'year'=>$PB,'text'=>$M['name'],'emails'=>array($M['email:home'],$M['email:other'],$M['email:work']));}else{$d=gmmktime(0,0,0,$v,$IB,date('Y',$QB));$n['all'][]=array('timestamp'=>$d,'year'=>$PB,'text'=>$M['name'],'emails'=>array($M['email:home'],$M['email:other'],$M['email:work']));$d=gmmktime(0,0,0,$v,$IB,date('Y',$QB)-1);$n['all'][]=array('timestamp'=>$d,'year'=>$PB,'text'=>$M['name'],'emails'=>array($M['email:home'],$M['email:other'],$M['email:work']));$d=gmmktime(0,0,0,$v,$IB,date('Y',$QB)+1);$n['all'][]=array('timestamp'=>$d,'year'=>$PB,'text'=>$M['name'],'emails'=>array($M['email:home'],$M['email:other'],$M['email:work']));}}}}$n['birthdays']=$n['all'];return$n;}static function load_search($F,$KC){$A=rcmail::get_instance();$cB='';$x=array();$L=array();if(!is_array($F)){$cB.="<tr><td>".self::$f->gettext('calendar.calsearchnomatches')."</td></tr>";$x=false;}else{$L=(array)$_SESSION['event_filters'];$L=array_flip($L);if(count($L)>0){$U=array();foreach($F as$B=>$K){if(isset($L[$K['categories']])||(isset($L['default'])&&$K['categories']=="")){$U[]=$K;}}}else{$U=$F;}foreach($U as$B=>$K){$eC=$A->config->get('cal_searchset',array('summary'));foreach($eC as$B=>$VB){$NB=$K[$VB];preg_match('/'.str_replace(array('%','*','#'),'(.*)',$KC).'/i',$NB,$yB);if(count($yB)>0){$fC='/'.implode('|',$yB).'/i';$NB=preg_replace($fC,'<a href="#"><font id="rcmmatch'.$K['event_id'].'" class="calsearchmatch">$0</font></a>',$NB);$OB=self::$f->gettext('calendar.'.$VB);if(strlen($OB)>7){$OB=substr($OB,0,3)." ...";}$CC=0;if($_SESSION['tzname']){$gC=date_default_timezone_get();date_default_timezone_set($_SESSION['tzname']);$CC=date('Z',$K['start'])-date('Z');date_default_timezone_set($gC);}$cB.="<tr id='rcmrow".$K['event_id']."' onclick='calendar_commands.gotoDate(\"".($K['start']+$CC)."\", \"".$K['event_id']."\")'><td><a href='#'>".$OB.'</a>: '.$NB."<span id='calsearch_eid_".$K['event_id']."' style='display:none'>".$K['event_id']."</span></td></tr>";$x[]=$K;break;}}}}return array('events'=>$x,'filters'=>$L,'rows'=>$cB);}static function load_boxtitle(){if($_SESSION['removelayers'])$CB=' - <a href="#" onclick="calendar_commands.switchCalendar()">'.self::$f->gettext('calendar.mycalendar').'</a>';else$CB=' - <a href="#" onclick="calendar_commands.switchCalendar()">'.self::$f->gettext('calendar.allcalendars').'</a>';$YB=$_SESSION['tzname'];$cC=calendar::getClientTimezone();$bC=str_replace('_',' ',calendar::getClientTimezoneName($cC));if($YB)$YB='&nbsp;@&nbsp;'.$bC;$I='<div id="calusernamecontent">'.rcmail::get_instance()->user->data['username'].'</span>'.$YB."\n";$I.='<span>&nbsp;</span>'."\n";$I.='<small>('.self::$f->gettext('calendar.filter').':'."\n";$I.='<span id="calfiltercontent"><a href="#" onclick="calendar_commands.filterEvents()">'.$_SESSION['calfilter'].'</a></span>)</small>'."\n";return$I;}static function load_import($N=false){if($N=='mainnav'){if(self::$calskin=='larry'){self::$f->add_button(array('command'=>'plugin.importEvents','id'=>'calimportbut','class'=>'button calimportbut','href'=>'#','title'=>'calendar.import','label'=>'calendar.import_short','type'=>'link'),'toolbar');}else{$S=getimagesize(INSTALL_PATH.'plugins/calendar_plus/skins/'.self::$calskin.'/images/import.png');self::$f->add_button(array('command'=>'plugin.importEvents','id'=>'calimportbut','width'=>$S[0],'height'=>$S[1],'href'=>'#','title'=>'calendar.import','imageact'=>'skins/'.self::$calskin.'/images/import.png'),'toolbar');}}}static function load_users($N=false){if($N=='mainnav'){if(self::$calskin=='larry'){self::$f->add_button(array('command'=>'plugin.calendar_switchCalendar','id'=>'calswitchbut','class'=>'button calswitchbut','href'=>'#','title'=>'calendar.switch_calendar','label'=>'calendar.user','type'=>'link'),'toolbar');}else{$S=getimagesize(INSTALL_PATH.'plugins/calendar_plus/skins/'.self::$calskin.'/images/users.png');self::$f->add_button(array('command'=>'plugin.calendar_switchCalendar','id'=>'calswitchbut','width'=>$S[0],'height'=>$S[1],'href'=>'#','title'=>'calendar.switch_calendar','imageact'=>'skins/'.self::$calskin.'/images/users.png'),'toolbar');}}else if($N=='html'){$A=rcmail::get_instance();$pB=$A->config->get('caldavs',array());ksort($pB);$h=array_merge($A->config->get('public_categories',array()),$A->config->get('categories',array()));$eB=html::tag('option',array('value'=>0),self::$f->gettext('calendar.allcalendars'));$eB.=html::tag('option',array('value'=>-1),self::$f->gettext('calendar.mycalendar'));foreach($pB as$R=>$YC){$eB.=html::tag('option',array('value'=>$R,'style'=>'background-color:#'.$h[$R]),$R.' ('.str_replace('%u',$_SESSION['username'],str_replace('%gu',$A->config->get('googleuser'),$YC['user'])).')');}return html::tag('select',array('name'=>'_caluser','id'=>'_caluser'),$eB);}}static function load_filters($N=false,$x=array()){if($N=='html'){$A=rcmail::get_instance();$h=array_merge($A->config->get('public_categories',array()),$A->config->get('categories',array()));$L=(array)$_SESSION['event_filters'];$L=array_flip($L);$GB="";if(isset($L['default']))$GB="checked";$JB='<div class="fc-event-skin" style="width:50px;float:left;" title="'.self::$f->gettext("calendar.defaultcategory").'"><center><input '.$GB.' name="_filters[]" type="checkbox" value="default" /></center></div>'."\r\n";foreach($h as$B=>$E){$GB="";if(isset($L[$B]))$GB="checked";$JB.='<div class="fc-event '.asciiwords($B,true,'').'" style="width:50px;float:left;" title="'.$B.'"><center><input '.$GB.' name="_filters[]" type="checkbox" value="'.$B.'" /></center></div>'."\r\n";}$JB.='<div style="clear:left;"></div>'."\r\n";return$JB;}else if($N=='filter'){$L=(array)$_SESSION['event_filters'];$L=array_flip($L);if(count($L)>0){$U=array();foreach($x as$B=>$K){if(isset($L[$K['classNameDisp']])||(isset($L['default'])&&$K['className']=="")){$U[]=$K;}}}else{$U=$x;}foreach($U as$B=>$K){if($K['start_unix']<$ZC&&$K['end_unix']<$ZC)unset($U[$B]);}return array_values($U);}else if($N=='set'){$L=get_input_value('_filters',RCUBE_INPUT_POST);if(is_array($L)){$_SESSION['event_filters']=get_input_value('_filters',RCUBE_INPUT_POST);$f='';foreach($_SESSION['event_filters']as$B=>$E){if($E=="default")$E=self::$f->gettext('calendar.defaultcategory');$f.="$E, ";}$f=substr($f,0,strlen($f)-2);if(strlen($f)>60){$f=substr($f,0,60).' ...';}$_SESSION['calfilter']=$f;}else{$_SESSION['calfilter']=self::$f->gettext('calendar.allevents');$_SESSION['event_filters']=array();}}else if($N=='mainnav'){if(self::$calskin=='larry'){self::$f->add_button(array('command'=>'plugin.calendar_filterEvents','id'=>'calfiltersbut','class'=>'button calfitersbut','href'=>'#','title'=>'calendar.filter_events','label'=>'calendar.filter','type'=>'link'),'toolbar');}else{$S=getimagesize(INSTALL_PATH.'plugins/calendar_plus/skins/'.self::$calskin.'/images/filter.png');self::$f->add_button(array('command'=>'plugin.calendar_filterEvents','id'=>'calfiltersbut','width'=>$S[0],'height'=>$S[1],'href'=>'#','title'=>'calendar.filter_events','imageact'=>'skins/'.self::$calskin.'/images/filter.png'),'toolbar');}}}static function load_print($N=false,$aC=null){$O=self::$calskin;if($N=='js'){self::$f->include_script("program/js/$aC.js");}else if($N=='mainnav'){self::$f->add_button(array('command'=>'plugin.calendar_print','id'=>'calprintprevbut','class'=>'button calprintprevbut','href'=>'#','title'=>'print','label'=>'print','type'=>'link'),'toolbar');}else if($N=='popupnav'){$S=getimagesize(INSTALL_PATH.'plugins/calendar_plus/skins/'.$O.'/images/toggle_view.png');self::$f->add_button(array('command'=>'plugin.calendar_toggle_view','id'=>'caltoggleviewbut','width'=>$S[0],'height'=>$S[1],'href'=>'#','title'=>'calendar.toggle_view','imagepas'=>'skins/'.$O.'/images/spacer.gif','imageact'=>'skins/'.$O.'/images/toggle_view.png'),'toolbar');$S=getimagesize(INSTALL_PATH.'plugins/calendar_plus/skins/'.$O.'/images/print.png');self::$f->add_button(array('command'=>'plugin.calendar_do_print','id'=>'calprintbut','width'=>$S[0],'height'=>$S[1],'href'=>'#','title'=>'print','imagepas'=>'skins/'.$O.'/images/spacer.gif','imageact'=>'skins/'.$O.'/images/print.png'),'toolbar');}}static function load_upcoming_cal(){$A=rcmail::get_instance();self::$f->require_plugin('qtip');$O=self::$calskin;self::$f->include_stylesheet('skins/'.$O.'/upcoming.css');self::$f->include_script('program/js/upcoming.js');self::$f->add_hook('render_page',array(self::$f,'upcoming_calendar'));if($A->action=='preview'||$A->action=='show'){self::$f->include_stylesheet('skins/'.$O.'/preview.css');}}static function load_ics_attachments(){$A=rcmail::get_instance();$O=self::$calskin;$hC='plugins/calendar_plus/skins/'.$O.'/images/ics.png';$A->output->set_env('calskin',$O);$A->output->set_env('ics_icon',$hC);self::$f->include_script("program/js/calendar.ics_icon.js");self::$f->add_hook('messages_list',array(self::$f,'pass_ics_header'));self::$f->add_hook('storage_init',array(self::$f,'fetch_ics_header'));}function switchUserToken($P){$A=rcmail::get_instance();if($_SESSION['user_id']!=$A->user->ID){if($mB=rc_request_header('X-Roundcube-Request')){$P['value']=$mB;}else if($mB=get_input_value('_token',RCUBE_INPUT_GPC)){$P['value']=$mB;}}return$P;}function upcoming_calendar($G){if($G['template']=='mail'||$G['template']=='message'){$A=rcmail::get_instance();$A->output->add_label('calendar.unloadwarning','calendar.successfullyreplicated','calendar.replicationtimeout','calendar.resumereplication','calendar.replicationfailed','calendar.replicationincomplete');$A->output->set_env('rc_date_format',$A->config->get('date_format','m/d/Y'));$A->output->set_env('rc_time_format',$A->config->get('time_format','H:i'));$A->output->add_header(calendar::generateCSS());$I='<div id="upcoming-content">'."\n";$I.='  <div id="today-title" class="boxtitle">'."\n";$I.='    <span id="calback"><a href="#">&laquo;</a>&nbsp;</span>'."\n";$I.='    <label for "today"><span id="caltoday"><a href="#">'.$A->gettext('today').'</a></span></label>'."\n";$I.='    <span id="calforward"><a href="#">&raquo</a></span>'."\n";$I.='  </div>'."\n";$I.='  <div id="upcoming-container">'."\n";$I.='    <div id="upcoming"></div>'."\n";for($ZB=1;$ZB<$A->config->get('cal_previews',0);$ZB++){$I.='    <div id="upcoming_'.$ZB.'"></div>'."\n";}$I.='  </div>'."\n";$I.='</div>'."\n";$I.='<div id="calendaroverlay"></div>'."\n";$A->output->add_footer($I);}return$G;}function pass_ics_header($G){if(is_array($G['messages'])){foreach($G['messages']as$vB){if($vB->others['x-rc-attachment']){$vB->list_flags['extra_flags']['ics']=1;}}}return$G;}function fetch_ics_header($G){$GC=array('X-RC-Attachment');$G['fetch_headers']=trim($G['fetch_headers'].' '.strtoupper(join(' ',$GC)));return$G;}function message_load($G){$this->message=$G['object'];foreach((array)$this->message->attachments as$y){if($y->mimetype=='text/calendar'||$y->mimetype=='text/ical'||$y->mimetype=='application/ics'){$this->ical_parts[$y->mime_id]=$y->mime_id;$_SESSION['ical_uid'][$y->mime_id]=$G['object']->uid;}}foreach((array)$this->message->parts as$HC=>$e){if($e->mimetype=='text/calendar'||$e->mimetype=='text/ical'){$this->ical_parts[$e->mime_id]=$e->mime_id;$_SESSION['ical_uid'][$e->mime_id]=$G['object']->uid;}}}function preview_events($G){$A=rcmail::get_instance();$k='';if($G['template']=='messagepreview'){$k='parent.';}if(is_array($this->myevents)){if(!$wB=@json_encode($this->myevents)){$wB=json_encode(array());}$A->output->add_script($k."rcmail.set_env({myevents:".$wB."});");}}function message_part_structure($G){if(is_array($G['structure']->parts)){foreach($G['structure']->parts as$B=>$E){if($E->mimetype=='text/calendar'||$E->mimetype=='text/ical'||$E->mimetype=='application/ics'||strstr(strtolower($E->filename),'.ics')){$this->ical_parts[$E->mime_id]=$E->mime_id;$_SESSION['ical_uid'][$E->mime_id]=$G['object']->uid;}}}return$G;}function html_import($G){if(is_array($this->ical_parts)){$A=rcmail::get_instance();$A->output->add_label('calendar.importconfirmation');$O=self::$calskin;$BC=array();foreach($this->ical_parts as$HC=>$z){$AC=$_SESSION['ical_uid'][$z];$zB=$z;$e=$AC&&$zB?$A->imap->get_message_part($AC,$zB,NULL,NULL,NULL,true):null;if($e){$U=(array)$this->utils->importEvents($e,false,true,'preview');$u=str_replace("\n","",serialize($U));$u=str_replace("\r","",$u);$u=md5(strtolower(str_replace(" ","",$u)));if($BC[$u])continue;$BC[$u]=true;$DB="<div id='upcoming_preview' style='padding: 0.5em;'><table id='upcoming_preview_table'>\n";$nB=0;foreach($U as$F){if(is_array($F)){$nB++;$DB.="<tr><td>".ucfirst($this->gettext('calendar.item')).":</td><td> #".$nB."</td></tr>\n";foreach($F as$B=>$E){$fB=false;if($B!='id'){if($B=='allDay'){$B='all-day';if($E==0)$E=$this->gettext('calendar.no');else$E=$this->gettext('calendar.yes');}if($B=='title')$B='summary';if($B=='start'||$B=='end'||$B=='expires'){if($F['allDay']){if(!is_numeric($E))$E=strtotime($E);$F[$B]=$E-$this->getClientTimezone()*3600;$E=$F[$B];}$E=date($A->config->get('date_long','d.m.Y H:i'),$F[$B.'_unix']);if($B=='start'){if($A->config->get('upcoming_cal',false))$E.=" <small>[<a href=\"javascript:void(0)\" onclick=\"calendar_icalattach.preview(".($F['start_unix']*1000).");\">".$this->gettext('calendar.preview')."</a>]</small>";$E.=" <small>[<a href=\"javascript:void(0)\" onclick=\"calendar_icalattach.save('".JQ($z)."', ".$nB.")\">".$this->gettext('import')."</a>]</small>";}if($B=='end'){if($F['end']==$F['start']){unset($F[$B]);$fB=true;}}}if($E==''){$fB=true;unset($F[$B]);}if($B=='description')$E='<pre>'.$E.'</pre>';if($fB!=true&&$B!='className'&&$B!='classNameDisp'&&$B!='editable'&&$B!='start_unix'&&$B!='end_unix'){$DB.="<tr><td>".ucfirst($this->gettext('calendar.'.$B)).":</td><td>".$E."</td></tr>\n";}}}}$DB.="<tr><td colspan=\"2\"><hr /></td></tr>\n";$this->myevents[]=$F;}$DB.="</table></div><br />\n";$G['content'].=html::tag('div',array('style'=>'clear: both; height: 25px;')).$DB;$G['content'].=html::tag('div',array('style'=>'clear: both;'));$G['content'].=html::p(array('id'=>'upcoming_preview_import','style'=>"margin:1em; padding:0.5em; border:1px solid #999; border-radius:4px; -moz-border-radius:4px; -webkit-border-radius:4px; width: auto;"),html::a(array('href'=>"#",'onclick'=>"return calendar_icalattach.save('".JQ($z)."', false)",'title'=>$this->gettext('calendar.addicalmsg')),html::img(array('src'=>$this->url("skins/$O/images/ical_save.png"),'align'=>'middle','title'=>'','alt'=>''))).' '.html::span(null,Q($this->gettext('calendar.addicalmsg'))));$G['content'].=html::tag('script',array('type'=>'text/javascript'),'$("#upcoming_preview").width($("#upcoming_preview_table").width()); $("#upcoming_preview_import").width($("#upcoming_preview").width());');}$this->include_script('program/js/calendar.icalattach.js');if($A->action=='preview'&&$this->show_upcoming_cal){$A->output->add_script('try{parent.$("#caltoday").click()}catch(e){$("#caltoday").click()}','foot');}}}return$G;}static function isSabreDAV($C){if(strpos($C,'access=')!==false){return false;}$A=rcmail::get_instance();$IC=array('%gu','%u',);$FC=array($A->config->get('googleuser'),$A->user->data['username'],);$C=str_replace($IC,$FC,$C);$j=new MyRCHttp;$gB['method']='GET';$gB['referrer']='http'.(rcube_https_check()?'s':'').'://'.$_SERVER['HTTP_HOST'].$_SERVER['PHP_SELF'];$gB['target']=$C;$j->initialize($gB);$j->useCurl(false);$j->SetTimeout(5);$j->execute();$I=($j->error)?$j->error:$j->result;if(substr($I,0,strlen('SabreDAV'))=='SabreDAV'){$rB=explode(':',$I);if($rB[1]&&strtolower($rB[1])==$_SERVER['HTTP_HOST']){return true;}else{return false;}}else{return false;}}function upload_field($G){$A=rcmail::get_instance();$_=array('id'=>'rcmUploadform','class'=>'uploadform');$HB=parse_bytes(ini_get('upload_max_filesize'));$jB=parse_bytes(ini_get('post_max_size'));if($jB&&$jB<$HB)$HB=$jB;$HB=show_bytes($HB);$JB=html::div($_,html::div(null,$this->upload_field_content(array('size'=>25))).html::div('hint',rcube_label(array('name'=>'maxuploadsize','vars'=>array('size'=>$HB)))));$G['content']=$JB;return$G;}function upload_field_content($_){$_['type']='file';$_['name']='calimport';$_['id']='calimport';$VB=new html_inputfield($_);return$VB->show();}}